{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PRIM MINIMUM SPANNING TREE</title>

<style>
#graphArea { overflow: hidden !important; }

.run-btn {
    margin-top: 18px;
    margin-bottom: 10px;
    padding: 14px 28px !important;
    font-size: 18px !important;
    border-radius: 12px !important;
    background: linear-gradient(135deg, #00f58a, #41ffd1);
    color: #000;
    font-weight: 600;
    box-shadow: 0 0 12px rgba(0,255,180,0.6);
    cursor: pointer;
    transition: .25s;
}

.run-btn:hover {
    transform: scale(1.10);
    background: linear-gradient(135deg, #35ff9d, #7affde);
    box-shadow: 0 0 18px rgba(0,255,200,0.9);
}

body {
    background-image: url("{% static 'graphs/images/purple_wave.png' %}");
    background-size: cover;
    background-position: 80px;
    background-attachment: fixed;
    font-family: 'Inter', sans-serif;
    color: #ffffff;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

.container {
    width: 85%;
    margin: auto;
    padding-top: 0px !important;
}

h1 {
    font-size: 52px;
    margin: 24px auto 32px;
    padding: 14px 80px;
    display: block;
    width: fit-content;
    text-transform: uppercase;
    letter-spacing: 3px;
    font-weight: 800;
    background: linear-gradient(120deg, #1f2b7a, #3f51b5, #00e5ff);
    border-radius: 999px;
    box-shadow: 0 0 22px rgba(0, 229, 255, 0.55);
    color: #ffffff;
    -webkit-text-fill-color: #faf7f7;
    text-shadow: 0 0 10px rgba(0,0,0,0.45);
}

.tab-buttons {
    text-align: center;
    margin-bottom: 30px;
}

.tab-btn {
    padding: 12px 26px;
    margin: 0 10px;
    border: none;
    border-radius: 10px;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
    transition: .25s;
    background: rgba(255,255,255,0.2);
    color: #ffffff;
    backdrop-filter: blur(6px);
}

.tab-btn.active {
    background: linear-gradient(135deg, #00e28a, #3dffcb);
    color: black;
    transform: scale(1.06);
}

.tab-btn:hover { transform: scale(1.06); }

.glass-box {
    background: rgba(255,255,255,0.08);
    padding: 25px;
    border-radius: 14px;
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 8px 30px rgba(0,0,0,0.45);
    margin-bottom: 40px;
}

.neon-title {
    font-size: 20px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    background: linear-gradient(90deg, #00fff0, #41ffd1, #ffe66d);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 10px rgba(0,255,200,0.8), 0 0 18px rgba(0,200,255,0.7);
    display: inline-block;
    position: relative;
}

.neon-title::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: -6px;
    width: 100%;
    height: 2px;
    border-radius: 999px;
    background: linear-gradient(90deg, #00e28a, #41ffd1);
    box-shadow: 0 0 10px rgba(0,255,200,0.8);
}

input, select {
    width: 100%;
    padding: 14px;
    font-size: 17px;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(180,150,255,0.45);
    border-radius: 12px;
    color: #e8ebff;
    outline: none;
    transition: .25s;
}

input:focus, select:focus {
    border-color: #c9b2ff;
    background: rgba(255,255,255,0.18);
    box-shadow: 0 0 15px #cdb3ff;
}

svg {
    width: auto;
    height: auto;
    min-width: 100%;
    min-height: 1500px;
    overflow: visible !important;
    border-radius: 16px;
    background: rgba(0,0,0,0.20);
    border: 1px solid rgba(255,255,255,0.1);
}
.home-btn { 
    position: absolute; 
    top: 20px; 
    left: 30px; 
    color: #41ffd1; 
    text-decoration: none; 
    border: 1px solid #41ffd1; 
    padding: 5px 15px; 
    border-radius: 5px; 
    background: rgba(0,0,0,0.5); 
}

.node circle { transition: all 0.3s ease; }
.node:hover circle { filter: brightness(1.4) drop-shadow(0 0 12px #0ff); }

.highlight-node circle { fill: #f7d206 !important; filter: drop-shadow(0 0 20px #f7d206); }
.edge { stroke: #eaee0d; stroke-width: 4; }
.highlight-edge { stroke: #ff4704 !important; stroke-width: 8 !important; animation: pulse 1.5s infinite; }

@keyframes pulse {
    0% { stroke-width: 6; opacity: 1; }
    50% { stroke-width: 10; opacity: 0.8; }
    100% { stroke-width: 6; opacity: 1; }
}

#totalWeight {
    font-size: 26px;
    font-weight: bold;
    color: #00ffea;
    text-shadow: 0 0 15px #00ffea;
    margin-top: 15px;
}

.pdf-wrapper {
    background: linear-gradient(135deg, rgba(32, 43, 122, 0.75), rgba(94, 52, 182, 0.6));
    padding: 40px;
    border-radius: 22px;
    border: 2px solid rgba(0, 255, 255, 0.35);
    box-shadow: 0 0 22px rgba(0, 255, 255, 0.25);
    backdrop-filter: blur(12px);
}
.pdf-header {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #ffffff;
    text-shadow: 0 0 10px rgba(0,0,0,0.6);
}
.pdf-header i {
    font-size: 30px;
    color: #79d7ff;
    filter: drop-shadow(0 0 6px #79d7ff);
}

#pdfTextBox {
    background: rgba(0, 0, 0, 0.55); 
    padding: 28px;
    border-radius: 16px;
    font-size: 18px;
    line-height: 1.8;
    color: #e6e6e6;        
    border-left: 4px solid #3df5ff;
    box-shadow: inset 0 0 20px rgba(0,255,255,0.25);
    white-space: pre-wrap;
}
#pdfTextBox * {
    color: #e6e6e6 !important;     
    background: transparent !important;
}
.graph-info-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 6px;
}

.graph-info-table th,
.graph-info-table td {
    border: 1px solid rgba(255,255,255,0.18);
    padding: 6px 8px;
}

.graph-info-table th {
    background: linear-gradient(90deg, #00e5ff, #2af598);
    color: #00131a;
    font-weight: 700;
    text-align: center;
}

.graph-info-table td {
    background: rgba(0,0,0,0.18);
}

.graph-info-title {
    font-weight: 700;
    font-size: 17px;
    margin-top: 4px;
    margin-bottom: 6px;
    color: #79d7ff;
}

.algo-intro {
    margin: 18px 0 6px;
    padding: 18px 24px;
    border-radius: 18px;
    background: linear-gradient(135deg,
        rgba(10, 25, 80, 0.85),
        rgba(40, 10, 90, 0.85)
    );
    border: 1px solid rgba(0, 255, 200, 0.35);
    box-shadow: 0 0 18px rgba(0, 255, 200, 0.25);
    backdrop-filter: blur(10px);
    color: #e6f3ff;
    font-size: 15px;
    line-height: 1.8;
}

.algo-intro-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(90deg, #00fff0, #41ffd1, #ffe66d);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 10px rgba(0,255,200,0.6);
}

.algo-intro-text {
    margin: 6px 0 10px;
}

.algo-intro-list {
    margin: 0 0 8px 18px;
    padding-left: 6px;
}

.algo-intro-list li {
    margin-bottom: 4px;
}

.algo-intro-note {
    margin-top: 4px;
    font-size: 14px;
    color: #b7c9ff;
}



.edge-highlight { stroke: #ffff00 !important; stroke-width: 7px !important; filter: drop-shadow(0 0 18px yellow); }
.edge-mst      { stroke: #00ff88 !important; stroke-width: 7px !important; filter: drop-shadow(0 0 22px #00ff88); }
.edge-rejected { stroke: #ff3366 !important; stroke-width: 3px; opacity: 0.35; }
.edge-candidate { stroke: #ffff88 !important; stroke-width: 5px; opacity: 0.7; }
</style>
</head>

<body>
<a href="/" class="home-btn">⬅ Trang Chủ</a>
<div class="container">

    <h1>PRIM MINIMUM SPANNING TREE</h1>

    <div class="tab-buttons">
        <button id="visualBtn" class="tab-btn active" onclick="showVisual()">Trực quan hoá</button>
        <button id="introBtn" class="tab-btn" onclick="showIntro()">Giới thiệu thuật toán</button>
    </div>

    <div id="visualPanel">
        <div class="algo-intro">
            <div class="algo-intro-title">
                Giới thiệu ngắn gọn về thuật toán Prim
            </div>
            <p class="algo-intro-text">
                Prim là thuật toán dùng để tìm <b>Cây khung nhỏ nhất (Minimum Spanning Tree – MST)</b>
                trên đồ thị <b>có trọng số, không hướng, liên thông</b>. Thuật toán bắt đầu từ một đỉnh
                xuất phát và <b>mở rộng dần cây</b> bằng cách luôn chọn cạnh có trọng số nhỏ nhất
                nối từ tập đỉnh đã chọn đến một đỉnh chưa chọn.
            </p>
            <ul class="algo-intro-list">
                <li><b>Bước 1:</b> Chọn một đỉnh bắt đầu, cho vào tập <b>đỉnh đã thăm</b>.</li>
                <li><b>Bước 2:</b> Ở mỗi bước, xét tất cả các cạnh đi ra từ tập đỉnh đã thăm
                    sang đỉnh chưa thăm, chọn cạnh có <b>trọng số nhỏ nhất</b> → thêm cạnh đó
                    và đỉnh mới vào MST.</li>
                <li><b>Bước 3:</b> Lặp lại cho đến khi tất cả các đỉnh đều được chọn
                    (MST có <b>n − 1 cạnh</b> với n là số đỉnh).</li>
            </ul>
            <p class="algo-intro-note">
                Ở bên dưới, bạn nhập danh sách đỉnh, các cạnh và chọn đỉnh bắt đầu. Hệ thống sẽ
                <b>trực quan hoá từng bước Prim</b> và hiển thị thêm <b>bậc đỉnh, danh sách kề,
                ma trận kề, trọng số các cạnh</b> của đồ thị.
            </p>
        </div>


        <div class="glass-box">
            <h3 class="neon-title">NHẬP DANH SÁCH ĐỈNH</h3>
            <input id="nodes" placeholder="VD: A,B,C,D,E">

            <h3 class="neon-title">NHẬP CÁC CẠNH VÀ TRỌNG SỐ</h3>
            <input id="edges" placeholder="VD: A-B-4, A-C-8, B-D-8, C-D-2, C-E-7, D-E-6">

            <h3 class="neon-title">CHỌN ĐỈNH BẮT ĐẦU</h3>
            <select id="startNode">
                <option value="">-- Chọn đỉnh bắt đầu --</option>
            </select>

            <div style="text-align:center; margin-top:25px;">
                <button class="run-btn" onclick="runPrim()">CHẠY PRIM</button>
            </div>
        </div>

        <div class="glass-box" style="display:flex; gap:30px; align-items:flex-start;">
            <div style="flex:2.5;">
                <svg id="graphArea"></svg>
                <div style="text-align:center; margin-top:20px;">
                    <span style="font-size:24px;">Tổng trọng số MST:</span>
                    <span id="totalWeight" style="font-size:30px; color:#00ffea;">0</span>
                </div>
            </div>

            <div style="
                flex:1;
                background:rgba(255,255,255,0.08);
                padding:20px;
                border-radius:14px;
                max-height:1500px;
                overflow-y:auto;
            ">
                <h3 style="color:#79d7ff; margin-top:0;">QUÁ TRÌNH THỰC HIỆN</h3>
                <div id="infoContent"
                    style="font-size:16px; line-height:1.7; color:#e0e7ff; margin-bottom:18px;">
                    Chưa chạy thuật toán...
                </div>

                <div style="height:1px; background:rgba(255,255,255,0.15); margin:10px 0 18px;"></div>

                <h3 style="color:#79d7ff; margin:0 0 6px;">THÔNG TIN ĐỒ THỊ</h3>
                <div id="graphInfoBox"
                    style="font-size:16px; line-height:1.7; color:#e0e7ff;">
                    Chưa có dữ liệu. Hãy nhập đỉnh/cạnh và bấm <b>CHẠY PRIM</b> để xem:
                    bậc các đỉnh, danh sách kề, ma trận kề và trọng số các cạnh.
                </div>
            </div>
        </div>
    </div>
    <div id="introPanel" style="display:none;">
    <div class="glass-box" 
         style="background: linear-gradient(135deg, rgba(32,43,122,0.75), rgba(94,52,182,0.6)); 
                padding: 40px; 
                border-radius: 22px;
                border: 2px solid rgba(0,255,255,0.35);
                box-shadow: 0 0 22px rgba(0,255,255,0.25);
                backdrop-filter: blur(12px);">

        <div class="pdf-wrapper" style="background: transparent; border: none; box-shadow: none; padding: 0;">
            
            <div class="pdf-header" 
                 style="font-size: 32px; 
                        font-weight: 700; 
                        margin-bottom: 22px; 
                        color: #ffffff;
                        text-shadow: 0 0 10px rgba(0,0,0,0.6);">
                Giới thiệu thuật toán Prim
            </div>

            <div id="pdfTextBox"
                 style= "
                    background:
                    rgba(0, 0, 0, 0.35);
                    backdrop-filter: blur(8px);
                    padding: 26px;
                    border-radius: 16px;
                    font-size: 18px;
                    line-height: 1.85;
                    color: #e8e8e8;
                    border-left: 4px solid #3df5ff;
                    box-shadow: inset 0 0 12px rgba(0, 255, 255, 0.22);
                ">
                Đang tải nội dung giới thiệu...
            </div>


</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="{% static 'graphs/js/algorithms_d3/prim/prim.js' %}"></script>

<script>
document.getElementById("nodes").addEventListener("input", function() {
    const nodes = this.value.split(",").map(s => s.trim()).filter(Boolean);
    const select = document.getElementById("startNode");
    select.innerHTML = '<option value="">-- Chọn đỉnh bắt đầu --</option>';
    nodes.forEach(n => select.add(new Option(n, n)));
});

function showVisual() {
    document.getElementById("visualPanel").style.display = "block";
    document.getElementById("introPanel").style.display = "none";
    document.getElementById("visualBtn").classList.add("active");
    document.getElementById("introBtn").classList.remove("active");
}

function showIntro() {
    document.getElementById("visualPanel").style.display = "none";
    document.getElementById("introPanel").style.display = "block";
    document.getElementById("visualBtn").classList.remove("active");
    document.getElementById("introBtn").classList.add("active");
    loadIntroText();
}
function updateGraphInfo(nodes, edges) {
    const box = document.getElementById("graphInfoBox");
    if (!box) return;

    if (!nodes || nodes.length === 0) {
        box.innerHTML = "<i>Chưa có đỉnh nào.</i>";
        return;
    }

    const seen = new Set();
    const nodeList = [];
    nodes.forEach(n => {
        if (!seen.has(n)) {
            seen.add(n);
            nodeList.push(n);
        }
    });

    const degree = {};
    const adj = {};
    nodeList.forEach(n => {
        degree[n] = 0;
        adj[n] = [];
    });

    const safeEdges = Array.isArray(edges) ? edges : [];

    safeEdges.forEach(e => {
        const u = e.source;
        const v = e.target;
        const w = e.weight ?? 1;

        if (!(u in degree)) {
            degree[u] = 0;
            adj[u] = [];
            nodeList.push(u);
        }
        if (!(v in degree)) {
            degree[v] = 0;
            adj[v] = [];
            nodeList.push(v);
        }

        degree[u] += 1;
        degree[v] += 1;

        adj[u].push(`${v} (${w})`);
        adj[v].push(`${u} (${w})`);
    });

    const idx = {};
    nodeList.forEach((n, i) => idx[n] = i);
    const n = nodeList.length;
    const matrix = Array.from({length: n}, () => Array(n).fill(0));

    safeEdges.forEach(e => {
        const u = e.source;
        const v = e.target;
        const w = e.weight ?? 1;
        if (idx[u] == null || idx[v] == null) return;
        const i = idx[u], j = idx[v];
        matrix[i][j] = w;
        matrix[j][i] = w;
    });

    const degreeRows = nodeList.map(n => `
        <tr>
            <td>${n}</td>
            <td style="text-align:center;">${degree[n]}</td>
        </tr>
    `).join("");

    const adjRows = nodeList.map(n => `
        <tr>
            <td>${n}</td>
            <td>${adj[n].length ? adj[n].join(", ") : "–"}</td>
        </tr>
    `).join("");

    const headerRow = `
        <tr>
            <th></th>
            ${nodeList.map(n => `<th>${n}</th>`).join("")}
        </tr>
    `;

    const matrixRows = nodeList.map((n, i) => `
        <tr>
            <th>${n}</th>
            ${matrix[i].map(v => `<td style="text-align:center;">${v}</td>`).join("")}
        </tr>
    `).join("");

    const edgeRows = safeEdges.map(e => `
        <tr>
            <td>${e.source} – ${e.target}</td>
            <td style="text-align:center;">${e.weight ?? 1}</td>
        </tr>
    `).join("");

    box.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:18px;">
            <div>
                <div class="graph-info-title">1. Bậc các đỉnh</div>
                <table class="graph-info-table">
                    <tr><th>Đỉnh</th><th>Bậc</th></tr>
                    ${degreeRows}
                </table>
            </div>

            <div>
                <div class="graph-info-title">2. Danh sách kề</div>
                <table class="graph-info-table">
                    <tr><th>Đỉnh</th><th>Các đỉnh kề (đỉnh, trọng số)</th></tr>
                    ${adjRows}
                </table>
            </div>

            <div>
                <div class="graph-info-title">3. Ma trận kề</div>
                <div style="overflow-x:auto;">
                    <table class="graph-info-table">
                        ${headerRow}
                        ${matrixRows}
                    </table>
                </div>
            </div>

            <div>
                <div class="graph-info-title">4. Trọng số các cạnh</div>
                <table class="graph-info-table">
                    <tr><th>Cạnh</th><th>Trọng số</th></tr>
                    ${edgeRows}
                </table>
            </div>
        </div>
    `;
}

function runPrim() {
    const nodesInput = document.getElementById("nodes").value.trim();
    const edgesInput = document.getElementById("edges").value.trim();
    const startNode   = document.getElementById("startNode").value.trim();

    if (!nodesInput || !edgesInput) {
        alert("Nhập đầy đủ đỉnh và cạnh đi nào anh ơi!");
        return;
    }
    if (!startNode) {
        alert("Chọn đỉnh bắt đầu đi nào!");
        return;
    }

    const logBox = document.getElementById("infoContent");
    if (!logBox) {
        console.error("Không tìm thấy #infoContent trong HTML!");
        return;
    }

    logBox.innerHTML = "<span style='color:#79d7ff; font-size:1.2em;'>Đang vẽ đồ thị...</span>";
    document.getElementById("totalWeight").textContent = "?";

    const nodes = nodesInput.split(",").map(s => s.trim()).filter(Boolean);
    const edges = edgesInput.split(",").map(s => {
        const p = s.trim().split("-");
        if (p.length < 2) return null;
        return {
            source: p[0].trim(),
            target: p[1].trim(),
            weight: p[2] ? parseInt(p[2]) : 1
        };
    }).filter(Boolean);

    initPrimGraph();          
    updateGraphInfo(nodes, edges);
    drawPrimGraph(nodes, edges);

    setTimeout(() => {
        logBox.innerHTML = `<span style='color:#79d7ff; font-size:1.2em;'>
            Đã vẽ xong đồ thị! Bắt đầu Prim từ đỉnh <b>${startNode}</b>...</span><br><br>`;
    }, 800);

    fetch("/api/graph/prim/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")?.value || ""
        },
        body: JSON.stringify({
            nodes: nodes,
            edges: edgesInput,
            startNode: startNode
        })
    })
    .then(r => {
        if (!r.ok) throw new Error("Server lỗi");
        return r.json();
    })
    .then(data => {
        if (data.error || data.mst_cost === -1) {
            logBox.innerHTML = "<span style='color:#ff4444; font-size:1.5em;'>ĐỒ THỊ KHÔNG LIÊN THÔNG HOẶC LỖI!</span>";
            return;
        }

        runPrimFromBackend(data.steps, data.mst_cost, startNode);

        document.getElementById("totalWeight").textContent = data.mst_cost;
    })
    .catch(err => {
        console.error(err);
        logBox.innerHTML += "<br><span style='color:#ff6688'>Backend lỗi, nhưng đồ thị vẫn hiện rồi nha!</span>";
    });
}


function loadIntroText() {
    fetch("/api/pdf-text/prim/")
        .then(res => {
            if (!res.ok) throw new Error("Không tải được PDF");
            return res.json();
        })
        .then(data => {
            if (data.html) {
                document.getElementById("pdfTextBox").innerHTML = data.html;
            } else if (data.text) {
                document.getElementById("pdfTextBox").innerHTML = `<pre>${data.text}</pre>`;
            } else {
                document.getElementById("pdfTextBox").innerHTML = "Không có nội dung.";
            }
        })
        .catch(() => {
            document.getElementById("pdfTextBox").innerHTML = 
                "<span style='color:#ff6688'>Lỗi tải nội dung giới thiệu thuật toán Prim!</span>";
        });
}

</script>
</body>
</html>
